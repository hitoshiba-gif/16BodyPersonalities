<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>完全版レポート | 16BodyPersonalities</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="./styles.css?v=2" />
  <link rel="stylesheet" href="./premium.css?v=1">
</head>

<body data-theme="NATURAL">
  <div class="wrap" id="app">

    <header class="site">
      <div class="brand">16Body<b>Personalities</b> <span class="pill">Premium</span></div>
      <div class="tools">
        <button class="btn" id="btn-save-img">画像保存</button>
        <button class="btn" id="btn-save-pdf">PDF保存</button>
        <button class="btn" id="btn-send-mail">自分に再送</button>
      </div>
    </header>

    <div id="premium-root" class="grid" style="margin-top:10px">
      <div class="card">
        <h2>読み込み中…</h2>
        <p class="muted">専用リンク（token）からあなたの完全版レポートを復元しています。</p>
      </div>
    </div>

    <div class="footer">
      <span>© 2025 16BodyPersonalities Project</span>
      <span class="muted">This report is personalized for you.</span>
    </div>

  </div>

  <!-- ====== html2canvas / jsPDF ====== -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- ====== GAS_URL を window に固定 ====== -->
  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbz_nqEUfi7lbvqK2SHkxO1dLW0uKTfhY7wbG80IlcCKgwbxn_MPJ50W64MhhjDygwJ4/exec"
  </script>

  <!-- ====== 便利関数・JSONP ====== -->
  <script>
    function normalize01(x, min=1, max=5){ return Math.max(0, Math.min(1, (x-min)/(max-min))); }
    function pct(x){ return Math.round(x*100); }
    function uniq(arr){ return [...new Set(arr.filter(Boolean))]; }
    function pickSome(arr, n){ const a = [...arr]; const out=[]; while(a.length && out.length<n){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); } return out; }

    function jsonp(url){
      return new Promise((resolve, reject)=>{
        const cb = '__jp' + Math.random().toString(36).slice(2);
        const s  = document.createElement('script');
        const q  = (url.includes('?')?'&':'?')+'callback='+cb;

        window[cb] = (data)=>{ resolve(data); cleanup(); };
        s.onerror  = ()=>{ reject(new Error('JSONP failed')); cleanup(); };

        s.src = url + q;
        s.async = true;
        document.head.appendChild(s);

        function cleanup(){ delete window[cb]; s.remove(); }
      });
    }
  </script>

  <!-- ====== types.js（type辞書） ====== -->
  <script src="./types.js"></script>

  <!-- ====== app と同じ resultView.js を読み込む ====== -->
  <script src="./js/resultView.js?v=1"></script>

  <!-- ====== token 読み込み → 結果表示 ====== -->
  <script>
  (async function boot(){
    try{
      const params = new URLSearchParams(location.search);
      const token  = params.get('token');

      let dataFromToken = null;

      // token があるなら GAS から復元
      if (token) {
        const url = `${GAS_URL}?kind=getPremium&token=${encodeURIComponent(token)}`;
        const res = await jsonp(url);
        if (res && (res.answers || res.code)) dataFromToken = res;
      }

      // 復元できたら state に注入
      if (dataFromToken?.answers) {
        window.state = window.state || {};
        state.answers = dataFromToken.answers;
      }

      // 結果描画（app と同じ renderResult を呼ぶ）
      if (typeof renderResult === 'function') {
        renderResult();
      } else if (typeof _renderResultCore === 'function') {
        _renderResultCore();
      } else {
        premiumRoot.innerHTML = `
          <div class="card"><h2>結果ビュー読み込み失敗</h2><p>resultView.js を確認してください。</p></div>
        `;
      }

    } catch(e) {
      console.error(e);
      premiumRoot.innerHTML = `
        <div class="card"><h2>エラー</h2><p>${e.message}</p></div>
      `;
    }
  })();
  </script>

</body>
</html>
