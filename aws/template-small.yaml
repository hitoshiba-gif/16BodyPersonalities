AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 16BodyPersonalities API Backend (db.t3.small対応版)

Globals:
  Function:
    Timeout: 30
    Runtime: nodejs18.x
    MemorySize: 512
    Environment:
      Variables:
        DB_HOST: !Ref DBHost
        DB_PORT: !Ref DBPort
        DB_NAME: !Ref DBName
        DB_USER: !Ref DBUser
        DB_PASSWORD: !Ref DBPassword
        DB_SSL: 'true'
        BASE_URL: !Ref BaseURL
        FROM_EMAIL: !Ref FromEmail
        NODE_ENV: production
        # db.t3.small (198接続) 対応: 接続数を抑える
        DB_POOL_MAX: '1'  # Lambda関数ごとの最大接続数を1に制限
        DB_POOL_MIN: '0'
        DB_POOL_IDLE_TIMEOUT: '30000'
    Layers:
      - !Ref DbLayer

Parameters:
  DBHost:
    Type: String
    Description: PostgreSQL host address
  DBPort:
    Type: String
    Default: '5432'
    Description: PostgreSQL port
  DBName:
    Type: String
    Default: '16bp_production'
    Description: Database name
  DBUser:
    Type: String
    Description: Database user
  DBPassword:
    Type: String
    NoEcho: true
    Description: Database password
  BaseURL:
    Type: String
    Default: 'https://16bodypersonalities.com'
    Description: Base URL for premium links
  FromEmail:
    Type: String
    Default: 'noreply@16bodypersonalities.com'
    Description: From email address for SES

Resources:
  # Lambda Layer (Database connection)
  DbLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: bp16-db-layer
      Description: Database connection and utilities
      ContentUri: lambda/layers/db-layer/nodejs/
      CompatibleRuntimes:
        - nodejs18.x
    Metadata:
      BuildMethod: nodejs18.x

  # API Gateway (スロットリング設定)
  Api:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      # スロットリング設定
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          ThrottlingBurstLimit: 50   # バースト時の最大リクエスト数（抑えめ）
          ThrottlingRateLimit: 30    # 1秒あたりの定常リクエスト数
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"
      GatewayResponses:
        DEFAULT_4XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"
        DEFAULT_5XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"

  # Lambda Functions

  SaveDiagnosisFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: bp16-saveDiagnosis
      CodeUri: lambda/functions/saveDiagnosis/
      Handler: index.handler
      Description: Save diagnosis results
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /diagnoses
            Method: POST

  GetStatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: bp16-getStats
      CodeUri: lambda/functions/getStats/
      Handler: index.handler
      Description: Get diagnosis statistics
      Environment:
        Variables:
          CACHE_TTL: '300'  # キャッシュを5分に延長
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /stats
            Method: GET

  SavePremiumFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: bp16-savePremium
      CodeUri: lambda/functions/savePremium/
      Handler: index.handler
      Description: Save premium report and issue token
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /premium
            Method: POST

  GetPremiumFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: bp16-getPremium
      CodeUri: lambda/functions/getPremium/
      Handler: index.handler
      Description: Get premium report by token
      Events:
        ApiPath:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /premium/{token}
            Method: GET
        ApiQuery:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /premium
            Method: GET

  ResendPremiumFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: bp16-resendPremium
      CodeUri: lambda/functions/resendPremium/
      Handler: index.handler
      Description: Resend premium URL by email
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /premium/resend
            Method: POST

  SaveContactFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: bp16-saveContact
      CodeUri: lambda/functions/saveContact/
      Handler: index.handler
      Description: Save contact inquiry
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /contact
            Method: POST

  # CloudWatch Alarms

  SaveDiagnosisErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: bp16-saveDiagnosis-errors
      AlarmDescription: Alert when saveDiagnosis has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref SaveDiagnosisFunction

  ApiThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: bp16-api-throttles
      AlarmDescription: Alert when API is throttling requests
      MetricName: Count
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ApiName
          Value: !Ref Api

Outputs:
  ApiEndpoint:
    Description: "API Gateway endpoint URL"
    Value: !Sub "https://${Api}.execute-api.${AWS::Region}.amazonaws.com/prod"
    Export:
      Name: 16BP-API-Endpoint

  DbLayerArn:
    Description: "DB Layer ARN"
    Value: !Ref DbLayer
    Export:
      Name: 16BP-DB-Layer-ARN

  MaxConcurrentExecutions:
    Description: "Total reserved concurrent executions"
    Value: "150"  # 60 + 20 + 30 + 20 + 10 + 10

  Configuration:
    Description: "Configuration summary"
    Value: "db.t3.small (198 connections) | Lambda pool: 1 conn/func | Total: 150 funcs = 150 connections (余裕あり)"
