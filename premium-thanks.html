<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>è³¼å…¥ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ | 16BodyPersonalities</title>
  <style>
    :root{ --ink:#111; --muted:#666; --line:#e5e7eb; --ok:#0c9248; --err:#b00020; }
    body{ font-family: system-ui,-apple-system,"Segoe UI",Inter,Arial,sans-serif; background:#fafafa; color:var(--ink); }
    .wrap{ max-width: 720px; margin: 32px auto 64px; padding: 0 16px; }
    .card{ background:#fff; border:1px solid var(--line); border-radius:16px; padding:20px; box-shadow:0 4px 20px rgba(0,0,0,.04); }
    h1{ font-size:22px; margin:0 0 8px; }
    p{ margin:6px 0; color:var(--muted); }
    .grid{ display:grid; gap:12px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input[type="email"]{ flex:1; min-width:240px; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font-size:14px; }
    button{ appearance:none; padding:10px 14px; border-radius:10px; border:1px solid #111; background:#111; color:#fff; font-weight:700; cursor:pointer; }
    button.secondary{ background:#fff; color:#111; }
    .ok{ color:var(--ok); font-weight:700; }
    .err{ color:var(--err); font-weight:700; }
    .small{ font-size:12px; color:var(--muted); }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#f4f4f5; border:1px solid var(--line); padding:2px 6px; border-radius:6px; }
    .pill{ display:inline-block; padding:4px 8px; border:1px solid var(--line); border-radius:999px; background:#f7f7f7; font-size:12px; color:#333; }
    .status{ padding:10px 12px; border:1px dashed var(--line); border-radius:10px; background:#fcfcfc; }
    .mt{ margin-top:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card grid">
      <div>
        <h1>ã”è³¼å…¥ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ ğŸ‰</h1>
        <p>æ±ºæ¸ˆã¯æ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚å®Œå…¨ç‰ˆURLã‚’ãŠé€ã‚Šã™ã‚‹ãŸã‚ã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®æœ€çµ‚ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡Œã„ã¾ã™ã€‚</p>
        <div class="status" id="status">æº–å‚™ä¸­â€¦</div>
      </div>

      <div class="grid">
        <div class="row">
          <label for="email"><span class="pill">å—å–ç”¨ãƒ¡ãƒ¼ãƒ«</span></label>
          <input id="email" type="email" placeholder="you@example.com" autocomplete="email" inputmode="email"/>
          <button id="send">ãƒ¡ãƒ¼ãƒ«é€ä¿¡</button>
          <button id="retry" class="secondary">ã‚‚ã†ä¸€åº¦é€ã‚‹</button>
        </div>
        <p class="small">â€» è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã‚‚ã”ç¢ºèªãã ã•ã„ã€‚å±Šã‹ãªã„å ´åˆã¯åˆ¥ã‚¢ãƒ‰ãƒ¬ã‚¹ã§å†é€ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚</p>
      </div>

      <div class="grid">
        <div class="row">
          <span class="pill">æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ID</span>
          <span id="sid" class="kbd">â€”</span>
        </div>
        <div class="row">
          <span class="pill">ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰</span>
          <span id="ls" class="kbd">â€”</span>
        </div>
      </div>

      <div class="row mt">
        <button id="toHome" class="secondary">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
  // ===== è¨­å®š =====
  window.GAS_URL = "https://script.google.com/macros/s/AKfycbyXSAsD_pwYc8EqN50hKo5birhs5EHSSZlO1XEwtD362zm9Pt0lVIeg79-x8ZLgkJ03/exec";

  // ===== JSONP =====
  window.jsonp = window.jsonp || function(url, timeoutMs=15000){
    return new Promise((resolve,reject)=>{
      const cb='jsonp_cb_'+Math.random().toString(36).slice(2);
      const t=setTimeout(()=>{cleanup();reject(new Error('timeout'));},timeoutMs);
      function cleanup(){clearTimeout(t);delete window[cb];script.remove();}
      window[cb]=(d)=>{cleanup();resolve(d);};
      const script=document.createElement('script');
      script.src=url+(url.includes('?')?'&':'?')+'callback='+cb;
      script.onerror=()=>{cleanup();reject(new Error('neterr'));};
      document.head.appendChild(script);
    });
  };

  // ===== util =====
  const qs=new URLSearchParams(location.search);
  const sessionIdLS=localStorage.getItem('km_session')||
    (localStorage.setItem('km_session',crypto.randomUUID()),localStorage.getItem('km_session'));
  const stripeSessionId=qs.get('session_id')||'';

 
/* ========= robust thanks boot ========= */
(function(){
  const $ = s => document.querySelector(s);
  const elStatus = $('#status');
  const elEmail  = $('#email');
  const elSend   = $('#send');
  const elRetry  = $('#retry');
  const elSid    = $('#sid');
  const elLs     = $('#ls');

  // å®‰å…¨ãª setStatus
  function setStatus(msg, kind){
    try{
      if (!elStatus) return;
      elStatus.textContent = msg;
      elStatus.classList.toggle('ok', kind==='ok');
      elStatus.classList.toggle('err', kind==='err');
    }catch(_){}
  }

  // 1) ã¾ãšã€Œç”Ÿå­˜ãƒ†ã‚¹ãƒˆã€
  setStatus('åˆæœŸåŒ–ä¸­â€¦', null);

  // 2) ä¾å­˜ã®æœ€ä½é™ï¼ˆGAS_URL / jsonpï¼‰ã‚’ç”¨æ„
  window.GAS_URL = window.GAS_URL || "ã€ã‚ãªãŸã®GASãƒ‡ãƒ—ãƒ­ã‚¤URLã€‘"; // â†å¿…ãšå·®ã—æ›¿ãˆï¼ˆ/exec ã§çµ‚ã‚ã‚‹ï¼‰
  if (!window.jsonp) {
    window.jsonp = function(url, timeoutMs=15000){
      return new Promise((resolve,reject)=>{
        const cb = 'jp_' + Math.random().toString(36).slice(2);
        const timer = setTimeout(()=>{cleanup(); reject(new Error('JSONP timeout'));}, timeoutMs);
        function cleanup(){
          clearTimeout(timer);
          try{ delete window[cb]; }catch(_){}
          if (script && script.parentNode) script.parentNode.removeChild(script);
        }
        window[cb] = (data)=>{ cleanup(); resolve(data); };
        const delim = url.includes('?') ? '&' : '?';
        const script = document.createElement('script');
        script.src = url + delim + 'callback=' + cb;
        script.onerror = ()=>{ cleanup(); reject(new Error('JSONP network error')); };
        document.head.appendChild(script);
      });
    };
  }

  // 3) è¡¨ç¤ºç”¨ã® ID ãªã©
  const qs = new URLSearchParams(location.search);
  const stripeSessionId = qs.get('session_id') || '';
  elSid && (elSid.textContent = stripeSessionId || 'ï¼ˆãªã—ï¼‰');

  const sessionIdLS = (()=>{
    try{
      const k='km_session';
      let v = localStorage.getItem(k);
      if (!v) { v = (crypto?.randomUUID?.() || Math.random().toString(36).slice(2)); localStorage.setItem(k, v); }
      return v;
    }catch(_){ return 'â€”'; }
  })();
  elLs && (elLs.textContent = sessionIdLS);

  // 4) è¨ºæ–­ã‚³ãƒ¼ãƒ‰æ¤œå‡ºï¼ˆã©ã®ã‚­ãƒ¼ã§ã‚‚æ‹¾ã†ï¼‰
  function normalizeCode(raw){
    if (!raw) return '';
    const c = String(raw).trim().toUpperCase();
    return /^[BM][NW][LU][CS]$/.test(c) ? c : '';
  }
  function sniffJson(keys){
    for (const k of keys){
      try{ const v = localStorage.getItem(k); if (!v) continue;
        const o = JSON.parse(v); if (o && typeof o==='object') return o;
      }catch(_){}
    }
    return null;
  }
  function sniffCodeFromLocalStorage(){
    const hits = [];
    for (let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i); const v = localStorage.getItem(k);
      const c1 = normalizeCode(v); if (c1) hits.push({k, code:c1});
      try{
        const o = JSON.parse(v);
        const paths = [['code'],['type'],['result','code'],['result','type'],['data','code'],['payload','code']];
        for (const p of paths){
          let cur=o; for (const seg of p){ cur = (cur && typeof cur==='object') ? cur[seg] : undefined; }
          const c2 = normalizeCode(cur); if (c2) hits.push({k, code:c2});
        }
        if (Array.isArray(o)){
          for (const it of o){ const c3 = normalizeCode(it?.code || it?.type); if (c3) hits.push({k, code:c3}); }
        }
      }catch(_){}
    }
    const prefer = ['km_pending_payload','bp_code','bp','result','answers','scores'];
    hits.sort((a,b)=>{
      const ai = prefer.findIndex(x=>a.k.includes(x)); const bi = prefer.findIndex(x=>b.k.includes(x));
      return (ai<0?999:ai) - (bi<0?999:bi);
    });
    return hits[0]?.code || '';
  }
  function buildPayload(){
    // æ—§ã‚­ãƒ¼ã®ç·å½“ãŸã‚Š
    const pending = (()=>{try{return JSON.parse(localStorage.getItem('km_pending_payload')||'{}')}catch(_){return {}}})();
    if (normalizeCode(pending?.code)){
      return { code: normalizeCode(pending.code), scores: pending.scores||{}, answers: pending.answers||{}, sessionId: pending.sessionId||sessionIdLS };
    }
    const code2 = normalizeCode(localStorage.getItem('bp_code')||localStorage.getItem('code'));
    const scores2 = sniffJson(['bp_scores','scores','km_scores','result_scores']) || {};
    const answers2= sniffJson(['bp_answers','answers','km_answers','result_answers']) || {};
    if (code2) return { code: code2, scores: scores2, answers: answers2, sessionId: sessionIdLS };

    const code3 = sniffCodeFromLocalStorage();
    if (code3){
      // ã‚¹ã‚³ã‚¢/å›ç­”ã¯ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰æ‹¾ã†
      const sc = scores2 || sniffJson(Object.keys(localStorage).filter(k=>/score/i.test(k))) || {};
      const an = answers2|| sniffJson(Object.keys(localStorage).filter(k=>/answer/i.test(k)))|| {};
      return { code: code3, scores: sc, answers: an, sessionId: sessionIdLS };
    }
    return { code:'', scores:{}, answers:{}, sessionId: sessionIdLS };
  }

  // 5) GAS é€ä¿¡
  async function sendToGAS(email, payload, {isRetry=false}={}){
    if (!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){
      setStatus('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚','err'); return;
    }
    if (!payload || !payload.code){ payload = buildPayload(); }
    const code = normalizeCode(payload.code);
    if (!code){ setStatus('è¨ºæ–­ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚è³¼å…¥å‰ã«è¨ºæ–­ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚','err'); return; }
    payload.code = code;

    setStatus('é€ä¿¡ä¸­â€¦');

    const url = window.GAS_URL
      + '?savePremium=1'
      + '&email='     + encodeURIComponent(email)
      + '&sessionId=' + encodeURIComponent(payload.sessionId || sessionIdLS)
      + '&code='      + encodeURIComponent(payload.code)
      + '&scores='    + encodeURIComponent(JSON.stringify(payload.scores||{}))
      + '&answers='   + encodeURIComponent(JSON.stringify(payload.answers||{}))
      + (stripeSessionId ? '&stripe_session='+encodeURIComponent(stripeSessionId) : '')
      + (isRetry ? '&retry=1' : '');

    try{
      const res = await window.jsonp(url);
      if (!res?.ok) throw new Error(res?.error || 'é€ä¿¡å¤±æ•—');
      // ãƒ­ãƒ¼ã‚«ãƒ«æƒé™¤
      localStorage.removeItem('km_email_pending');
      localStorage.removeItem('km_pending_payload');
      setStatus('âœ… å®Œäº†ã—ã¾ã—ãŸï¼ãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ï¼ˆè¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ã‚‚ï¼‰ã€‚','ok');
    }catch(err){
      console.error(err);
      setStatus('ã‚¨ãƒ©ãƒ¼ï¼šé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚','err');
    }
  }

  // 6) è‡ªå‹•ã‚­ãƒƒã‚¯ï¼ˆå®‰å…¨ç‰ˆï¼‰
  try{
    const pendingEmail = localStorage.getItem('km_email_pending') || '';
    if (pendingEmail) elEmail && (elEmail.value = pendingEmail);

    const payload = buildPayload();
    const codeDbg = payload.code ? payload.code : 'ï¼ˆæœªæ¤œå‡ºï¼‰';
    const dbg = document.createElement('div');
    dbg.className='small'; dbg.style.marginTop='6px';
    dbg.textContent = 'æ¤œå‡ºã—ãŸè¨ºæ–­ã‚³ãƒ¼ãƒ‰ï¼š' + codeDbg;
    elStatus && elStatus.insertAdjacentElement('afterend', dbg);

    if (payload.code && (elEmail?.value || pendingEmail)){
      setStatus('è‡ªå‹•é€ä¿¡ã‚’è©¦è¡Œã—ã¦ã„ã¾ã™â€¦');
      sendToGAS(elEmail.value || pendingEmail, payload).catch(()=>{});
    }else{
      setStatus('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ã€Œãƒ¡ãƒ¼ãƒ«é€ä¿¡ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
    }
  }catch(err){
    console.error(err);
    setStatus('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ï¼š' + (err?.message||err), 'err');
  }

  // 7) ãƒœã‚¿ãƒ³
  elSend?.addEventListener('click', ()=>{
    const email = elEmail.value.trim();
    localStorage.setItem('km_email_pending', email);
    sendToGAS(email, buildPayload());
  });
  elRetry?.addEventListener('click', ()=>{
    const email = (elEmail.value.trim() || localStorage.getItem('km_email_pending') || '').trim();
    sendToGAS(email, buildPayload(), {isRetry:true});
  });
})();

  </script>
</body>
</html>