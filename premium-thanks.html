<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>è³¼å…¥ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ | 16BodyPersonalities</title>
  <style>
    :root{ --ink:#111; --muted:#666; --line:#e5e7eb; --ok:#0c9248; --err:#b00020; }
    body{ font-family: system-ui,-apple-system,"Segoe UI",Inter,Arial,sans-serif; background:#fafafa; color:var(--ink); }
    .wrap{ max-width: 720px; margin: 32px auto 64px; padding: 0 16px; }
    .card{ background:#fff; border:1px solid var(--line); border-radius:16px; padding:20px; box-shadow:0 4px 20px rgba(0,0,0,.04); }
    h1{ font-size:22px; margin:0 0 8px; }
    p{ margin:6px 0; color:var(--muted); }
    .grid{ display:grid; gap:12px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input[type="email"]{ flex:1; min-width:240px; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font-size:14px; }
    button{ appearance:none; padding:10px 14px; border-radius:10px; border:1px solid #111; background:#111; color:#fff; font-weight:700; cursor:pointer; }
    button.secondary{ background:#fff; color:#111; }
    .ok{ color:var(--ok); font-weight:700; }
    .err{ color:var(--err); font-weight:700; }
    .small{ font-size:12px; color:var(--muted); }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#f4f4f5; border:1px solid var(--line); padding:2px 6px; border-radius:6px; }
    .pill{ display:inline-block; padding:4px 8px; border:1px solid var(--line); border-radius:999px; background:#f7f7f7; font-size:12px; color:#333; }
    .status{ padding:10px 12px; border:1px dashed var(--line); border-radius:10px; background:#fcfcfc; }
    .mt{ margin-top:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card grid">
      <div>
        <h1>ã”è³¼å…¥ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ ğŸ‰</h1>
        <p>æ±ºæ¸ˆã¯æ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚å®Œå…¨ç‰ˆURLã‚’ãŠé€ã‚Šã™ã‚‹ãŸã‚ã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®æœ€çµ‚ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡Œã„ã¾ã™ã€‚</p>
        <div class="status" id="status">æº–å‚™ä¸­â€¦</div>
      </div>

      <div class="grid">
        <div class="row">
          <label for="email"><span class="pill">å—å–ç”¨ãƒ¡ãƒ¼ãƒ«</span></label>
          <input id="email" type="email" placeholder="you@example.com" autocomplete="email" inputmode="email"/>
          <button id="send">ãƒ¡ãƒ¼ãƒ«é€ä¿¡</button>
          <button id="retry" class="secondary">ã‚‚ã†ä¸€åº¦é€ã‚‹</button>
        </div>
        <p class="small">â€» è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã‚‚ã”ç¢ºèªãã ã•ã„ã€‚å±Šã‹ãªã„å ´åˆã¯åˆ¥ã‚¢ãƒ‰ãƒ¬ã‚¹ã§å†é€ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚</p>
      </div>

      <div class="grid">
        <div class="row">
          <span class="pill">æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ID</span>
          <span id="sid" class="kbd">â€”</span>
        </div>
        <div class="row">
          <span class="pill">ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰</span>
          <span id="ls" class="kbd">â€”</span>
        </div>
      </div>

      <div class="row mt">
        <button id="toHome" class="secondary">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
  // ===== è¨­å®š =====
  window.GAS_URL = "https://script.google.com/macros/s/AKfycbyXSAsD_pwYc8EqN50hKo5birhs5EHSSZlO1XEwtD362zm9Pt0lVIeg79-x8ZLgkJ03/exec";

  // ===== JSONP =====
  window.jsonp = window.jsonp || function(url, timeoutMs=15000){
    return new Promise((resolve,reject)=>{
      const cb='jsonp_cb_'+Math.random().toString(36).slice(2);
      const t=setTimeout(()=>{cleanup();reject(new Error('timeout'));},timeoutMs);
      function cleanup(){clearTimeout(t);delete window[cb];script.remove();}
      window[cb]=(d)=>{cleanup();resolve(d);};
      const script=document.createElement('script');
      script.src=url+(url.includes('?')?'&':'?')+'callback='+cb;
      script.onerror=()=>{cleanup();reject(new Error('neterr'));};
      document.head.appendChild(script);
    });
  };

  // ===== util =====
  const qs=new URLSearchParams(location.search);
  const sessionIdLS=localStorage.getItem('km_session')||
    (localStorage.setItem('km_session',crypto.randomUUID()),localStorage.getItem('km_session'));
  const stripeSessionId=qs.get('session_id')||'';

  const $=(s)=>document.querySelector(s);
  const elStatus=$('#status');
  const elEmail=$('#email');
  const elSend=$('#send');
  const elRetry=$('#retry');
  const elSid=$('#sid');
  const elLs=$('#ls');
  const elHome=$('#toHome');

  elSid.textContent=stripeSessionId||'ï¼ˆãªã—ï¼‰';
  elLs.textContent=sessionIdLS||'â€”';

  function setStatus(msg,kind){
    elStatus.textContent=msg;
    elStatus.classList.toggle('ok',kind==='ok');
    elStatus.classList.toggle('err',kind==='err');
  }

  // ===== payload å¾©å…ƒ =====
  function safeJson(s){try{return JSON.parse(s);}catch(_){return null;}}

// === ã“ã“ã‹ã‚‰å·®ã—æ›¿ãˆ ===

// 4æ–‡å­—ã‚³ãƒ¼ãƒ‰æ¤œè¨¼ï¼ˆå‰å¾Œç©ºç™½ãƒ»å°æ–‡å­—ã‚‚è¨±å¯ï¼‰
function normalizeCode(raw){
  if (!raw) return '';
  const c = String(raw).trim().toUpperCase();
  return /^[BM][NW][LU][CS]$/.test(c) ? c : '';
}

// localStorage å…¨èµ°æŸ»ã—ã¦ 4æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’æ¢ã™
function sniffCodeFromLocalStorage(){
  const candidates = [];
  for (let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    const v = localStorage.getItem(k);
    // å€¤ãŒçŸ­ã„æ–‡å­—åˆ—ãªã‚‰ãã®ã¾ã¾ãƒã‚§ãƒƒã‚¯
    if (v && v.length <= 16) {
      const code = normalizeCode(v);
      if (code) candidates.push({k, code, where:'value'});
    }
    // JSONã£ã½ã‘ã‚Œã°æ·±æ˜ã‚Š
    try{
      const obj = JSON.parse(v);
      // ã‚ˆãã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç·å½“ãŸã‚Š
      const paths = [
        ['code'],
        ['type'],
        ['result','code'],
        ['result','type'],
        ['data','code'],
        ['payload','code'],
        ['km','code'],
      ];
      for (const p of paths){
        let cur = obj;
        for (const seg of p){ cur = (cur && typeof cur==='object') ? cur[seg] : undefined; }
        const code = normalizeCode(cur);
        if (code) candidates.push({k, code, where:'json:'+p.join('.')});
      }
      // é…åˆ—ã®ä¸­ã«ã‚‚å…¥ã£ã¦ã‚‹ã‚±ãƒ¼ã‚¹
      if (Array.isArray(obj)) {
        for (const item of obj){
          const code = normalizeCode(item?.code || item?.type);
          if (code) candidates.push({k, code, where:'jsonArray'});
        }
      }
    }catch(_){}
  }
  // ã‚‚ã£ã¨ã‚‚â€œãã‚Œã£ã½ã„â€ã‚­ãƒ¼ã‚’å„ªå…ˆ
  const prefer = ['km_pending_payload','bp_code','bp','result','answers','scores'];
  candidates.sort((a,b)=>{
    const ai = prefer.findIndex(x=>a.k.includes(x)); const bi = prefer.findIndex(x=>b.k.includes(x));
    return (ai<0?999:ai) - (bi<0?999:bi);
  });
  return candidates[0]?.code || '';
}

// ã‚¹ã‚³ã‚¢ç­‰ã‚‚ç·å½“ãŸã‚Šå¾©å…ƒ
function sniffJson(nameList){
  for (const name of nameList){
    try{
      const v = localStorage.getItem(name);
      if (!v) continue;
      const obj = JSON.parse(v);
      if (obj && typeof obj==='object') return obj;
    }catch(_){}
  }
  return null;
}

function buildPayload(){
  // 1) æ—§å®Ÿè£…äº’æ›
  const pending = (()=>{ try{return JSON.parse(localStorage.getItem('km_pending_payload')||'{}')}catch(_){return {}}})();
  if (normalizeCode(pending?.code)) {
    return {
      code: normalizeCode(pending.code),
      scores: pending.scores || {},
      answers: pending.answers || {},
      sessionId: pending.sessionId || sessionIdLS
    };
  }

  // 2) å˜ä½“ã‚­ãƒ¼ä¿å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³
  const code2 = normalizeCode(localStorage.getItem('bp_code') || localStorage.getItem('code') || '');
  const scores2 = sniffJson(['bp_scores','scores','km_scores','result_scores']);
  const answers2= sniffJson(['bp_answers','answers','km_answers','result_answers']);
  if (code2) {
    return {
      code: code2,
      scores: scores2 || {},
      answers: answers2 || {},
      sessionId: sessionIdLS
    };
  }

  // 3) æ±ç”¨ã‚¹ãƒ‹ãƒ•ã‚¡ï¼ˆå…¨ã‚­ãƒ¼èµ°æŸ»ï¼‰
  const code3 = sniffCodeFromLocalStorage();
  if (code3) {
    // ã‚¹ã‚³ã‚¢é¡ã¯ãã‚Œã£ã½ã„ã‚­ãƒ¼ã‹ã‚‰æ‹¾ã†
    const sc = scores2 || sniffJson(Object.keys(localStorage).filter(k=>/score/i.test(k)));
    const an = answers2|| sniffJson(Object.keys(localStorage).filter(k=>/answer/i.test(k)));
    return { code: code3, scores: sc||{}, answers: an||{}, sessionId: sessionIdLS };
  }

  // 4) è¦‹ã¤ã‹ã‚‰ãªã„
  return { code:'', scores:{}, answers:{}, sessionId: sessionIdLS };
}

// æ¤œå‡ºã—ãŸã‚³ãƒ¼ãƒ‰ã‚’ç”»é¢ã«å‡ºã—ã¦ãƒ‡ãƒãƒƒã‚°ã—ã‚„ã™ã
(function(){
  const p = buildPayload();
  const dbg = document.createElement('div');
  dbg.className = 'small';
  dbg.style.marginTop = '6px';
  dbg.textContent = 'æ¤œå‡ºã—ãŸè¨ºæ–­ã‚³ãƒ¼ãƒ‰: ' + (p.code || 'ï¼ˆæœªæ¤œå‡ºï¼‰');
  document.getElementById('status').insertAdjacentElement('afterend', dbg);
})();

// é€ä¿¡å‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ normalize æ¸ˆã¿ã‚³ãƒ¼ãƒ‰ã§åˆ¤å®š
async function sendToGAS(email,payload,{isRetry=false}={}){
  if(!email||!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){
    setStatus('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err'); return;
  }
  if(!payload||!payload.code) payload = buildPayload();

  // â† ã“ã“ã‚’ normalize ã§å†ãƒã‚§ãƒƒã‚¯
  const code = normalizeCode(payload.code);
  if(!code){
    setStatus('è¨ºæ–­ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚è³¼å…¥å‰ã®ãƒšãƒ¼ã‚¸ã§ä¸€åº¦è¨ºæ–­â†’è³¼å…¥ã‚’å®Ÿè¡Œã—ç›´ã—ã¦ãã ã•ã„ã€‚','err'); 
    return;
  }
  payload.code = code;

  setStatus('é€ä¿¡ä¸­â€¦');

  const url=window.GAS_URL
    + '?savePremium=1'
    + '&email='     + encodeURIComponent(email)
    + '&sessionId=' + encodeURIComponent(payload.sessionId||sessionIdLS)
    + '&code='      + encodeURIComponent(payload.code)
    + '&scores='    + encodeURIComponent(JSON.stringify(payload.scores||{}))
    + '&answers='   + encodeURIComponent(JSON.stringify(payload.answers||{}))
    + (stripeSessionId ? '&stripe_session='+encodeURIComponent(stripeSessionId) : '')
    + (isRetry ? '&retry=1':'');
  try{
    const res=await window.jsonp(url);
    if(!res?.ok) throw new Error(res?.error||'failed');
    localStorage.removeItem('km_email_pending');
    localStorage.removeItem('km_pending_payload');
    setStatus('âœ… å®Œäº†ã—ã¾ã—ãŸï¼ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚','ok');
  }catch(err){
    console.error(err);
    setStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚','err');
  }
}
// === ã“ã“ã¾ã§å·®ã—æ›¿ãˆ ===

  // ===== è‡ªå‹•é€ä¿¡ =====
  (function autoKick(){
    if(pendingPayload&&pendingPayload.code&&(pendingEmail||elEmail.value)){
      setStatus('è‡ªå‹•ã§é€ä¿¡ã‚’è©¦è¡Œã—ã¦ã„ã¾ã™â€¦');
      sendToGAS(elEmail.value||pendingEmail,pendingPayload).catch(()=>{});
    }else{
      setStatus('ãƒ¡ãƒ¼ãƒ«ã‚’å…¥åŠ›ã—ã¦ã€Œãƒ¡ãƒ¼ãƒ«é€ä¿¡ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„');
    }
  })();

  elSend.addEventListener('click',()=>{
    const email=elEmail.value.trim();
    localStorage.setItem('km_email_pending',email);
    sendToGAS(email,pendingPayload);
  });
  elRetry.addEventListener('click',()=>{
    const email=elEmail.value.trim()||pendingEmail;
    sendToGAS(email,pendingPayload,{isRetry:true});
  });
  elHome.addEventListener('click',()=>location.href='./index.html');
  </script>
</body>
</html>