<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>è³¼å…¥ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ | 16BodyPersonalities</title>
  <style>
    :root{ --ink:#111; --muted:#666; --line:#e5e7eb; --ok:#0c9248; --err:#b00020; }
    body{ font-family: system-ui,-apple-system,"Segoe UI",Inter,Arial,sans-serif; background:#fafafa; color:var(--ink); }
    .wrap{ max-width: 720px; margin: 32px auto 64px; padding: 0 16px; }
    .card{ background:#fff; border:1px solid var(--line); border-radius:16px; padding:20px; box-shadow:0 4px 20px rgba(0,0,0,.04); }
    h1{ font-size:22px; margin:0 0 8px; }
    p{ margin:6px 0; color:var(--muted); }
    .grid{ display:grid; gap:12px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input[type="email"]{ flex:1; min-width:240px; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font-size:14px; }
    button{ appearance:none; padding:10px 14px; border-radius:10px; border:1px solid #111; background:#111; color:#fff; font-weight:700; cursor:pointer; }
    button.secondary{ background:#fff; color:#111; }
    .ok{ color:var(--ok); font-weight:700; }
    .err{ color:var(--err); font-weight:700; }
    .small{ font-size:12px; color:var(--muted); }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#f4f4f5; border:1px solid var(--line); padding:2px 6px; border-radius:6px; }
    .pill{ display:inline-block; padding:4px 8px; border:1px solid var(--line); border-radius:999px; background:#f7f7f7; font-size:12px; color:#333; }
    .status{ padding:10px 12px; border:1px dashed var(--line); border-radius:10px; background:#fcfcfc; }
    .mt{ margin-top:12px; }
    .hide{ display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card grid">
      <div>
        <h1>ã”è³¼å…¥ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ ğŸ‰</h1>
        <p>æ±ºæ¸ˆã¯æ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚å®Œå…¨ç‰ˆURLã‚’ãŠé€ã‚Šã™ã‚‹ãŸã‚ã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®æœ€çµ‚ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡Œã„ã¾ã™ã€‚</p>
        <div class="status" id="status">æº–å‚™ä¸­â€¦</div>
      </div>

      <div class="grid">
        <div class="row">
          <label for="email"><span class="pill">å—å–ç”¨ãƒ¡ãƒ¼ãƒ«</span></label>
          <input id="email" type="email" placeholder="you@example.com" autocomplete="email" inputmode="email"/>
          <button id="send">ãƒ¡ãƒ¼ãƒ«é€ä¿¡</button>
          <button id="retry" class="secondary">ã‚‚ã†ä¸€åº¦é€ã‚‹</button>
        </div>
        <p class="small">â€» è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã‚‚ã”ç¢ºèªãã ã•ã„ã€‚å±Šã‹ãªã„å ´åˆã¯åˆ¥ã‚¢ãƒ‰ãƒ¬ã‚¹ã§å†é€ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚</p>
      </div>

      <div class="grid">
        <div class="row">
          <span class="pill">æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ID</span>
          <span id="sid" class="kbd">â€”</span>
        </div>
        <div class="row">
          <span class="pill">ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰</span>
          <span id="ls" class="kbd">â€”</span>
        </div>
      </div>

      <div class="row mt">
        <button id="toHome" class="secondary">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
  // ====== è¨­å®šï¼ˆæ—¢å­˜ãŒã‚ã‚Œã°æµç”¨ï¼‰ ======
  // æ—¢ã« global ã« GAS_URL / jsonp ãŒã‚ã‚‹ãªã‚‰ä¸‹ã®å®šç¾©ã¯è‡ªå‹•ã§ç„¡åŠ¹åŒ–ã•ã‚Œã¾ã™ã€‚
  window.GAS_URL = window.GAS_URL || "https://script.google.com/macros/s/AKfycbzRZrR7lq3cGTuzJ10sJeB_XZOo2IrQncvGHM1T_BsPxqvV1XwNiAXDrLfRipUopXL6/exec"; // â†å·®ã—æ›¿ãˆ

  // ç°¡æ˜“ JSONPï¼ˆæœªå®šç¾©ãªã‚‰æ³¨å…¥ï¼‰
  if (typeof window.jsonp !== 'function') {
    window.jsonp = function(url, timeoutMs = 15000){
      return new Promise((resolve, reject)=>{
        const cb = 'jsonp_cb_' + Math.random().toString(36).slice(2);
        const t = setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);
        function cleanup(){
          clearTimeout(t);
          try{ delete window[cb]; }catch(_){}
          if (script && script.parentNode) script.parentNode.removeChild(script);
        }
        window[cb] = (data)=>{ cleanup(); resolve(data); };
        const delim = url.includes('?') ? '&' : '?';
        const script = document.createElement('script');
        script.src = url + delim + 'callback=' + cb;
        script.onerror = ()=>{ cleanup(); reject(new Error('JSONP network error')); };
        document.head.appendChild(script);
      });
    };
  }

  // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
  const qs = new URLSearchParams(location.search);
  const sessionIdLS = localStorage.getItem('km_session') ||
                      (localStorage.setItem('km_session', (crypto?.randomUUID?.()||Math.random().toString(36).slice(2))),
                       localStorage.getItem('km_session'));

  // Stripe Checkout / Payment Link ãŒä»˜ã‘ã‚‹å¯èƒ½æ€§ã‚ã‚Š
  const stripeSessionId = qs.get('session_id') || '';

  // è³¼å…¥å‰ã«ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿
  const pendingEmail   = localStorage.getItem('km_email_pending') || '';
  const pendingPayload = (()=>{ try{ return JSON.parse(localStorage.getItem('km_pending_payload')||'{}'); }catch(_){ return {}; }})();

  // UIè¦ç´ 
  const $ = (sel)=>document.querySelector(sel);
  const elStatus = $('#status');
  const elEmail  = $('#email');
  const elSend   = $('#send');
  const elRetry  = $('#retry');
  const elSid    = $('#sid');
  const elLs     = $('#ls');
  const elHome   = $('#toHome');

  // åˆæœŸè¡¨ç¤º
  elSid.textContent = stripeSessionId || 'ï¼ˆãªã—ï¼‰';
  elLs.textContent  = sessionIdLS || 'â€”';
  if (pendingEmail) elEmail.value = pendingEmail;

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºè£œåŠ©
  function setStatus(msg, kind){
    elStatus.textContent = msg;
    elStatus.classList.toggle('ok', kind==='ok');
    elStatus.classList.toggle('err', kind==='err');
  }

  // GAS ã«é€ã‚‹æœ¬ä½“
  async function sendToGAS(email, payload, {isRetry=false}={}){
    if (!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){
      setStatus('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'err');
      elEmail.focus();
      return;
    }
    setStatus('é€ä¿¡ä¸­â€¦å°‘ã—ãŠå¾…ã¡ãã ã•ã„ã€‚');

    // payload æº–å‚™ï¼ˆä¸è¶³é …ç›®ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    const code    = payload?.code    || 'UNKNOWN';
    const scores  = payload?.scores  || {};
    const answers = payload?.answers || {};
    const sess    = payload?.sessionId || sessionIdLS;

    // JSONP URLï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã«æƒãˆã‚‹ï¼‰
    const url = window.GAS_URL
      + '?savePremium=1'
      + '&email='     + encodeURIComponent(email)
      + '&sessionId=' + encodeURIComponent(sess)
      + '&code='      + encodeURIComponent(code)
      + '&scores='    + encodeURIComponent(JSON.stringify(scores))
      + '&answers='   + encodeURIComponent(JSON.stringify(answers))
      + (stripeSessionId ? '&stripe_session=' + encodeURIComponent(stripeSessionId) : '')
      + (isRetry ? '&retry=1' : '');

    try{
      const res = await window.jsonp(url);
      if (!res || !res.ok){
        throw new Error(res?.error || 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      // é€ä¿¡æˆåŠŸï¼šãƒ­ãƒ¼ã‚«ãƒ«æƒé™¤
      localStorage.removeItem('km_email_pending');
      localStorage.removeItem('km_pending_payload');

      setStatus('âœ… å®Œäº†ã—ã¾ã—ãŸï¼ å®Œå…¨ç‰ˆã®URLã‚’ãƒ¡ãƒ¼ãƒ«ã§ãŠé€ã‚Šã—ã¾ã—ãŸã€‚è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ã‚‚ã”ç¢ºèªãã ã•ã„ã€‚', 'ok');
    }catch(err){
      console.error(err);
      setStatus('ã‚¨ãƒ©ãƒ¼ï¼šé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'err');
    }
  }

  // è‡ªå‹•é€ä¿¡ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿ä¸€åº¦ã ã‘ï¼‰
  (function autoKick(){
    if (pendingPayload && Object.keys(pendingPayload).length && (pendingEmail || elEmail.value)){
      setStatus('è‡ªå‹•ã§é€ä¿¡ã‚’è©¦è¡Œã—ã¦ã„ã¾ã™â€¦');
      sendToGAS(elEmail.value || pendingEmail, pendingPayload).catch(()=>{});
    }else{
      setStatus('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã—ã¦ã€Œãƒ¡ãƒ¼ãƒ«é€ä¿¡ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
    }
  })();

  // ãƒœã‚¿ãƒ³å‹•ä½œ
  elSend.addEventListener('click', ()=>{
    const email = elEmail.value.trim();
    // thanks ãƒšãƒ¼ã‚¸ã§æ‰“ã¡ç›´ã™å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€æœ€æ–°ãƒ¡ãƒ¼ãƒ«ã‚’ä¿å­˜ï¼ˆæ¬¡å›å†è¨ªæ™‚ã«å¾©å…ƒï¼‰
    localStorage.setItem('km_email_pending', email);
    sendToGAS(email, pendingPayload);
  });

  elRetry.addEventListener('click', ()=>{
    const email = elEmail.value.trim() || pendingEmail;
    sendToGAS(email, pendingPayload, {isRetry:true});
  });

  elHome.addEventListener('click', ()=>{
    // å¿…è¦ã«å¿œã˜ã¦ãƒˆãƒƒãƒ—ã¸ã®ãƒ‘ã‚¹ã«å¤‰æ›´
    location.href = './app.html';
  });
  </script>
</body>
</html>