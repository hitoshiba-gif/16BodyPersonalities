<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ã”è³¼å…¥ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ ğŸ’– | 16BodyPersonalities</title>

  <!-- ãµã‚“ã‚ã‚Šä¸¸ã‚´ç³»ã§â€œã‹ã‚ã„ã•â€UPï¼ˆFallback: system-uiï¼‰ -->
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg1:#fff6fb; --bg2:#f5fbff; --bg3:#fffef6;
      --ink:#222; --muted:#6b7280; --line:#ece7f2;
      --accent:#ff86c8; --accent-2:#7ec8ff; --accent-3:#ffd36e;
      --ok:#0ca36d; --err:#d7266a;
      --card:#ffffff;
      --radius:22px;
      --shadow:0 10px 30px rgba(0,0,0,.06);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:"Zen Maru Gothic", system-ui, -apple-system, "Segoe UI", sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1600px 600px at -10% -10%, var(--bg1), transparent 60%),
        radial-gradient(1200px 700px at 110% 0%, var(--bg2), transparent 60%),
        radial-gradient(1000px 700px at 50% 120%, var(--bg3), transparent 60%),
        #fff;
      min-height:100svh;
    }

    .wrap{ max-width:820px; margin:28px auto 64px; padding:0 16px; position:relative; }

    /* ã‚†ã‚‹ã„é£¾ã‚Šé›²ï¼ˆèƒŒæ™¯ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼‰ */
    .blob{
      position:absolute; filter:blur(30px); opacity:.55; z-index:0; pointer-events:none;
      border-radius:60%;
      animation: float 10s ease-in-out infinite;
    }
    .blob.a{ width:160px; height:160px; left:-30px; top:-20px; background:linear-gradient(135deg,#ffd8ef,#ffe3f6);}
    .blob.b{ width:200px; height:200px; right:30px; top:-20px; background:linear-gradient(135deg,#d6f0ff,#e6f7ff); animation-delay: -2s;}
    .blob.c{ width:180px; height:180px; left:20px; bottom:-40px; background:linear-gradient(135deg,#fff1bf,#ffe9a1); animation-delay: -4s;}
    @keyframes float{ 0%,100%{ transform:translateY(0)} 50%{ transform:translateY(10px)} }

    .card{
      position:relative; z-index:1;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:24px clamp(16px,4vw,32px);
      box-shadow:var(--shadow);
    }

    .hero{
      display:flex; gap:16px; align-items:center; justify-content:flex-start; flex-wrap:wrap;
      margin-bottom:8px;
    }
    .sticker{
      width:54px; height:54px; border-radius:16px;
      background: conic-gradient(from 0deg, #ffd6f3, #e6f2ff, #fff1bf, #ffd6f3);
      display:grid; place-items:center; box-shadow:0 6px 20px rgba(0,0,0,.08);
      transform:rotate(-6deg);
      border:1px solid #ffffffaa;
    }
    .sticker i{ font-size:26px; }

    h1{
      margin:0; font-size:24px; line-height:1.2;
      letter-spacing:.02em;
    }
    .sub{
      margin-top:4px; color:var(--muted);
      font-size:14px;
    }
    .status{
      margin-top:12px;
      padding:12px 14px;
      background:#fffafd;
      border:1px dashed #ffd1ec;
      color:#a11e60;
      border-radius:14px;
      font-size:14px;
    }
    .status.ok{ background:#f1fff8; border-color:#c7f5df; color:#0a7d57;}
    .status.err{ background:#fff2f6; border-color:#ffc6d6; color:#c01452;}

    .bubble{
      margin-top:16px;
      background:#ffffff;
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
    }
    .bubble .cap{ font-size:13px; color:var(--muted); margin-bottom:8px; }
    .linkbox{
      border:1px dashed #e7e0f0; background:#fafaff;
      padding:12px; border-radius:12px;
      word-break:break-all; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:14px;
    }

    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button{
      appearance:none; cursor:pointer; border:none;
      padding:12px 16px; font-weight:700; font-size:14px;
      border-radius:999px; transition:transform .05s ease, box-shadow .2s ease, opacity .15s;
    }
    button.primary{
      background:linear-gradient(90deg, var(--accent), #ffa6da);
      color:#fff; box-shadow:0 8px 18px rgba(255,134,200,.35);
    }
    button.sky{
      background:linear-gradient(90deg, var(--accent-2), #a8dcff);
      color:#0b3753; box-shadow:0 8px 18px rgba(126,200,255,.30);
    }
    button.ghost{
      background:#fff; color:#2b2b2b; border:1px solid var(--line);
    }
    button:active{ transform:translateY(1px); }
    button:disabled{ opacity:.6; pointer-events:none; }

    .note{
      font-size:12.5px; color:var(--muted); margin-top:6px;
    }

    .footer-row{ margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; }
    .chip{ display:inline-flex; align-items:center; gap:6px;
      padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:#fff; font-size:13px; color:#555; }

    /* æˆåŠŸæ¼”å‡ºï¼ˆãƒãƒ¼ãƒˆ&ã‚¹ã‚¿ãƒ¼ç´™å¹é›ªï¼‰ */
    .confetti{ position:fixed; inset:0; pointer-events:none; z-index:999; overflow:hidden; }
    .confetti i{
      position:absolute; will-change:transform, opacity;
      animation: fall 1800ms ease-in forwards;
      font-size:18px;
      filter:drop-shadow(0 3px 6px rgba(0,0,0,.12));
    }
    @keyframes fall{
      0%{ transform:translateY(-20px) rotate(0deg); opacity:0 }
      10%{ opacity:1 }
      100%{ transform:translateY(75vh) rotate(540deg); opacity:0 }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <span class="blob a"></span>
    <span class="blob b"></span>
    <span class="blob c"></span>

    <div class="card">
      <div class="hero">
        <div class="sticker"><i>âœ¨</i></div>
        <div>
          <h1>ã”è³¼å…¥ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ ğŸ’–</h1>
          <div class="sub">æ±ºæ¸ˆã¯æ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚ã‚ãªãŸå°‚ç”¨ã®ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¬ãƒãƒ¼ãƒˆãƒªãƒ³ã‚¯ã‚’ç™ºè¡Œã—ã¾ã™ã€‚</div>
        </div>
      </div>

      <div id="status" class="status">æº–å‚™ä¸­â€¦</div>

      <div id="link-area" class="bubble" style="display:none">
        <div class="cap">ğŸ”— ã‚ãªãŸå°‚ç”¨ãƒªãƒ³ã‚¯</div>
        <div id="linkBox" class="linkbox">ç”Ÿæˆä¸­...</div>
        <div class="btns">
          <button id="openLink" class="sky">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¬ãƒãƒ¼ãƒˆã‚’é–‹ã ğŸ’</button>
          <button id="copyLink" class="primary">ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ âœ¨</button>
          <button id="toHome" class="ghost">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
        </div>
        <div class="note">ã“ã®URLã¯â€œã‚ãªãŸå°‚ç”¨â€ã€‚ä¿å­˜ã—ã¦ãŠã‘ã°ã€ãƒ¬ãƒãƒ¼ãƒˆãŒã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã•ã‚Œã¦ã‚‚ã„ã¤ã§ã‚‚æœ€æ–°ã‚’è¦‹ã‚‰ã‚Œã¾ã™ã€‚</div>
      </div>

      <div class="footer-row">
        <span class="chip">ğŸ”’ æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³IDï¼š<code id="sid">â€”</code></span>
        <span class="chip">ğŸ’¾ ãƒ­ãƒ¼ã‚«ãƒ«ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼š<code id="ls">â€”</code></span>
      </div>
    </div>
  </div>

  <!-- æˆåŠŸæ¼”å‡ºã‚³ãƒ³ãƒ†ãƒŠ -->
  <div class="confetti" id="confetti" aria-hidden="true"></div>

  <script>
  // ===== è¨­å®š =====
  const API_URL = "https://uk952hkt2e.execute-api.ap-northeast-1.amazonaws.com/prod";
  const BASE_URL = "https://16bodypersonalities.com"; // å›ºå®šãƒ‰ãƒ¡ã‚¤ãƒ³

  // ===== DOM =====
  const $ = s=>document.querySelector(s);
  const elStatus = $('#status');
  const elLinkArea = $('#link-area');
  const elLinkBox = $('#linkBox');
  const elOpen = $('#openLink');
  const elCopy = $('#copyLink');
  const elHome = $('#toHome');
  const elSid = $('#sid');
  const elLs = $('#ls');
  const confettiRoot = $('#confetti');

  // ãƒªãƒˆãƒ©ã‚¤ä»˜ãfetchï¼ˆæœ€å¤§3å›è©¦è¡Œã€æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰
  async function fetchWithRetry(url, options = {}, retries = 3, delay = 1000) {
    for (let i = 0; i < retries; i++) {
      try {
        const response = await fetch(url, options);
        if (response.status >= 500 && i < retries - 1) {
          console.log(`[Retry] ${i + 1}/${retries - 1} after ${delay}ms (status: ${response.status})`);
          await new Promise(resolve => setTimeout(resolve, delay));
          delay *= 2;
          continue;
        }
        return response;
      } catch (error) {
        if (i < retries - 1) {
          console.log(`[Retry] ${i + 1}/${retries - 1} after ${delay}ms (error: ${error.message})`);
          await new Promise(resolve => setTimeout(resolve, delay));
          delay *= 2;
          continue;
        }
        throw error;
      }
    }
  }

  function setStatus(msg, kind){
    elStatus.textContent = msg;
    elStatus.classList.toggle('ok', kind==='ok');
    elStatus.classList.toggle('err', kind==='err');
  }

  // ã‹ã‚ã„ã„ç´™å¹é›ªï¼ˆãƒãƒ¼ãƒˆï¼†ã‚¹ã‚¿ãƒ¼ï¼‰
  function popKawaii(){
    const items = ['ğŸ’–','âœ¨','ğŸŒ¸','ğŸ’','â­ï¸','ğŸ’'];
    for(let i=0;i<26;i++){
      const node = document.createElement('i');
      node.textContent = items[i % items.length];
      const startX = Math.random()*100; // vw
      const dur = 1200 + Math.random()*900;
      node.style.left = startX+'vw';
      node.style.top = '-10px';
      node.style.animationDuration = dur+'ms';
      confettiRoot.appendChild(node);
      setTimeout(()=> node.remove(), dur+50);
    }
  }

  // ===== util =====
  const qs = new URLSearchParams(location.search);
  const stripeSessionId = qs.get('session_id') || '';
  elSid.textContent = stripeSessionId || 'â€”';

  const sessionIdLS = (()=>{ try{
    const k='km_session'; let v=localStorage.getItem(k);
    if(!v){ v = (crypto?.randomUUID?.() || Math.random().toString(36).slice(2)); localStorage.setItem(k,v); }
    return v;
  }catch{ return 'â€”' }})();
  elLs.textContent = sessionIdLS;

  function normalizeCode(raw){
    if(!raw) return '';
    const c=String(raw).trim().toUpperCase();
    return /^[BM][NW][LU][CS]$/.test(c) ? c : '';
  }
  function sniffJson(keys){
    for(const k of keys){
      try{ const v=localStorage.getItem(k); if(!v)continue;
        const o=JSON.parse(v); if(o && typeof o==='object') return o;
      }catch{}
    }
    return null;
  }
  function sniffCode(){
    const hits=[];
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i), v=localStorage.getItem(k);
      const c1=normalizeCode(v); if(c1) hits.push({k,code:c1});
      try{
        const o=JSON.parse(v);
        if(o?.code){ const c2=normalizeCode(o.code); if(c2) hits.push({k,code:c2}); }
      }catch{}
    }
    return hits[0]?.code || '';
  }
  function buildPayload(){
    const pending = (()=>{ try{return JSON.parse(localStorage.getItem('km_pending_payload')||'{}')}catch{ return {} }})();
    if(normalizeCode(pending?.code)){
      return { code: normalizeCode(pending.code),
               scores: pending.scores||{},
               answers: pending.answers||{},
               sessionId: pending.sessionId||sessionIdLS };
    }
    const code2 = normalizeCode(localStorage.getItem('bp_code')||localStorage.getItem('code')) || sniffCode();
    const scores2 = sniffJson(['bp_scores','scores','km_scores','result_scores'])||{};
    const answers2 = sniffJson(['bp_answers','answers','km_answers','result_answers'])||{};
    return { code: code2, scores:scores2, answers:answers2, sessionId:sessionIdLS };
  }

  async function issueLink(payload){
    if(!payload?.code){ setStatus('è¨ºæ–­ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«è¨ºæ–­ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚','err'); return; }
    setStatus('ãƒªãƒ³ã‚¯ã‚’ç™ºè¡Œä¸­â€¦âœ¨');

    const body = {
      code: payload.code,
      scores: payload.scores || {},
      answers: payload.answers || {},
      sessionId: payload.sessionId,
      noMail: true
    };
    if(stripeSessionId) body.stripe_session = stripeSessionId;

    try{
      const response = await fetchWithRetry(`${API_URL}/premium`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const res = await response.json();
      if(!res?.ok) throw new Error(res?.error || 'é€ä¿¡å¤±æ•—');
      const token = res?.token || res?.data?.token || '';
      if(!token) throw new Error('tokenãªã—');
      const fullURL = (res.link || (BASE_URL + '/premium.html?token=' + encodeURIComponent(token)));

      elLinkBox.textContent = fullURL;
      elLinkBox.dataset.url = fullURL;
      try{ localStorage.setItem('bp_premium_link', fullURL); }catch{}

      elLinkArea.style.display = 'block';
      setStatus('ã§ãã¾ã—ãŸï¼ãƒªãƒ³ã‚¯ã‚’ä¿å­˜ã—ã¦ã­ ğŸ’•','ok');
      popKawaii();
    }catch(e){
      console.error(e);
      setStatus('ã‚¨ãƒ©ãƒ¼ï¼š'+(e?.message||e), 'err');
    }
  }

  // ===== èµ·å‹• =====
  window.addEventListener('DOMContentLoaded', ()=>{
    // æ—¢å­˜ãƒªãƒ³ã‚¯ãŒã‚ã‚Œã°ä¸€ç¬ã§è¦‹ã›ã‚‹ï¼ˆUXé‡è¦–ï¼‰
    const saved = localStorage.getItem('bp_premium_link');
    if(saved){
      elLinkBox.textContent = saved;
      elLinkBox.dataset.url = saved;
      elLinkArea.style.display = 'block';
      setStatus('ä»¥å‰ã®ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤ºä¸­ âœ¨', 'ok');
    }

    const payload = buildPayload();
    if(payload.code){
      issueLink(payload);
    }else{
      setStatus('è¨ºæ–­ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆapp.htmlã§è¨ºæ–­â†’è³¼å…¥ã®é †ã§é€²ã‚ã¦ãã ã•ã„ï¼‰','err');
    }
  });

  // ===== Buttons =====
  elCopy.addEventListener('click', ()=>{
    const url = elLinkBox.dataset.url || elLinkBox.textContent;
    navigator.clipboard.writeText(url).then(()=>{
      setStatus('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ ğŸ’–', 'ok');
      popKawaii();
    }).catch(()=> setStatus('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦', 'err'));
  });

  elOpen.addEventListener('click', ()=>{
    const url = elLinkBox.dataset.url || elLinkBox.textContent;
    if(url) window.open(url, '_blank', 'noopener');
  });

  elHome.addEventListener('click', ()=> location.href='index.html');
  </script>
</body>
</html>
